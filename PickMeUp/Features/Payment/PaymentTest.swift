//
//  PaymentTest.swift
//  PickMeUp
//
//  Created by ÍπÄÌÉúÌòï on 6/9/25.
//
// MARK: - 1. Í≤∞Ï†ú Í¥ÄÎ†® Î™®Îç∏ Ï∂îÍ∞Ä

import SwiftUI
import WebKit
import iamport_ios

// Í≤∞Ï†ú Ï†ïÎ≥¥ Î™®Îç∏
struct PaymentInfo: Equatable, Hashable {
    let orderID: String
    let orderCode: String
    let totalPrice: Int
    let storeName: String
    let menuItems: [CartItem]
    let createdAt: String
}

// Í≤∞Ï†ú Í≤∞Í≥º Î™®Îç∏
struct PaymentResult {
    let isSuccess: Bool
    let impUID: String?
    let merchantUID: String
    let errorMessage: String?
}

// MARK: - PaymentView
struct PaymentView: View {
    let paymentInfo: PaymentInfo
    @ObservedObject var router: AppRouter
    @State private var isPaymentInProgress = false
    @State private var paymentResult: PaymentResult?
    @State private var showingResult = false
    @State private var showingWebView = false  // üöÄ Ï∂îÍ∞Ä

    // üöÄ WKWebViewÎ•º @StateÎ°ú Í¥ÄÎ¶¨
    @State private var webView: WKWebView?

    var body: some View {
        VStack(spacing: 20) {
            if showingWebView && webView != nil {
                // üöÄ Í≤∞Ï†ú WebView ÌëúÏãú
                WebViewRepresentable(webView: webView!)
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                // Ï£ºÎ¨∏ Ï†ïÎ≥¥ ÌëúÏãú
                OrderSummaryView(paymentInfo: paymentInfo)

                Spacer()

                // Í≤∞Ï†ú Î≤ÑÌäº
                Button(action: {
                    startPayment()
                }) {
                    HStack {
                        if isPaymentInProgress {
                            ProgressView()
                                .progressViewStyle(CircularProgressViewStyle(tint: .white))
                                .scaleEffect(0.8)
                        }
                        Text(isPaymentInProgress ? "Í≤∞Ï†ú ÏßÑÌñâ Ï§ë..." : "Í≤∞Ï†úÌïòÍ∏∞")
                            .font(.headline)
                    }
                    .frame(maxWidth: .infinity)
                    .padding()
                    .background(Color.blue)
                    .foregroundColor(.white)
                    .cornerRadius(12)
                }
                .disabled(isPaymentInProgress)
                .padding()
            }
        }
        .navigationTitle("Í≤∞Ï†ú")
        .navigationBarTitleDisplayMode(.inline)
        .navigationBarBackButtonHidden(true)
        .navigationBarItems(leading: Button("Ï∑®ÏÜå") {
            if showingWebView {
                // Í≤∞Ï†ú Ï§ëÏùº ÎïåÎäî WebViewÎßå Ïà®ÍπÄ
                showingWebView = false
                isPaymentInProgress = false
            } else {
                // ÏùºÎ∞òÏ†ÅÏù∏ Îí§Î°úÍ∞ÄÍ∏∞
                router.pop()
            }
        })
        .sheet(isPresented: $showingResult) {
            PaymentResultView(
                result: paymentResult,
                onDismiss: {
                    showingResult = false
                    if paymentResult?.isSuccess == true {
                        router.reset()
                    }
                }
            )
        }
    }

    // MARK: - Í≤∞Ï†ú ÏãúÏûë
    private func startPayment() {
        isPaymentInProgress = true
        showingWebView = true  // üöÄ WebView ÌëúÏãú

        // üöÄ WKWebView ÏÉùÏÑ±
        let wkWebView = WKWebView()
        wkWebView.backgroundColor = UIColor.clear
        self.webView = wkWebView

        let payment = IamportPayment(
            pg: PG.html5_inicis.makePgRawName(pgId: "INIpayTest"),
            merchant_uid: paymentInfo.orderCode,
            amount: "\(paymentInfo.totalPrice)"
        ).then {
            $0.pay_method = PayMethod.card.rawValue
            $0.name = "\(paymentInfo.storeName)"
            $0.buyer_name = "ÍπÄÌÉúÌòï"
            $0.app_scheme = "pickmeup"
        }

        // Ìè¨Ìä∏Ïõê Í≤∞Ï†ú Ïã§Ìñâ
        Iamport.shared.paymentWebView(
            webViewMode: wkWebView,
            userCode: "imp14511373",
            payment: payment
        ) { iamportResponse in
            DispatchQueue.main.async {
                self.showingWebView = false  // üöÄ WebView Ïà®ÍπÄ
                self.handlePaymentResponse(iamportResponse)
            }
        }
    }

    // MARK: - Í≤∞Ï†ú ÏùëÎãµ Ï≤òÎ¶¨
    private func handlePaymentResponse(_ response: IamportResponse?) {
        isPaymentInProgress = false

        guard let response = response else {
            paymentResult = PaymentResult(
                isSuccess: false,
                impUID: nil,
                merchantUID: paymentInfo.orderCode,
                errorMessage: "Í≤∞Ï†ú ÏùëÎãµÏù¥ ÏóÜÏäµÎãàÎã§."
            )
            showingResult = true
            return
        }

        if response.success == true {
            // Í≤∞Ï†ú ÏÑ±Í≥µ
            paymentResult = PaymentResult(
                isSuccess: true,
                impUID: response.imp_uid,
                merchantUID: response.merchant_uid ?? paymentInfo.orderCode,
                errorMessage: nil
            )

            // ÏÑúÎ≤ÑÏóê Í≤∞Ï†ú Í≤ÄÏ¶ù ÏöîÏ≤≠
            Task {
                await verifyPayment(impUID: response.imp_uid ?? "", merchantUID: response.merchant_uid ?? "")
            }
        } else {
            // Í≤∞Ï†ú Ïã§Ìå®
            paymentResult = PaymentResult(
                isSuccess: false,
                impUID: response.imp_uid,
                merchantUID: response.merchant_uid ?? paymentInfo.orderCode,
                errorMessage: response.error_msg ?? "Í≤∞Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§."
            )
        }

        showingResult = true
    }

    // MARK: - Í≤∞Ï†ú Í≤ÄÏ¶ù
    private func verifyPayment(impUID: String, merchantUID: String) async {
        print("üí≥ Í≤∞Ï†ú Í≤ÄÏ¶ù ÏãúÏûë - impUID: \(impUID), merchantUID: \(merchantUID)")

        // Í≤∞Ï†ú Í≤ÄÏ¶ù ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞
        let verifyRequest = PaymentValidationRequest(imp_uid: impUID)

        do {
            let result = try await NetworkManager.shared.fetch(
                PaymentRouter.verify(request: verifyRequest),
                successType: PaymentValidationResponse.self,
                failureType: CommonMessageResponse.self
            )

            await MainActor.run {
                if let success = result.success {
                    print("‚úÖ Í≤∞Ï†ú Í≤ÄÏ¶ù ÏôÑÎ£å: \(success)")
                    // Í≤ÄÏ¶ù ÏÑ±Í≥µ Ïãú Í≤∞Ï†ú Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
                    if let currentResult = paymentResult {
                        paymentResult = PaymentResult(
                            isSuccess: true,
                            impUID: currentResult.impUID,
                            merchantUID: currentResult.merchantUID,
                            errorMessage: nil
                        )
                    }
                } else if let failure = result.failure {
                    print("‚ùå Í≤∞Ï†ú Í≤ÄÏ¶ù Ïã§Ìå®: \(failure.message)")
                    // Í≤ÄÏ¶ù Ïã§Ìå® Ïãú Í≤∞Ï†ú Ïã§Ìå® Ï≤òÎ¶¨
                    if let currentResult = paymentResult {
                        paymentResult = PaymentResult(
                            isSuccess: false,
                            impUID: currentResult.impUID,
                            merchantUID: currentResult.merchantUID,
                            errorMessage: "Í≤∞Ï†ú Í≤ÄÏ¶ù Ïã§Ìå®: \(failure.message)"
                        )
                    }
                }
            }
        } catch {
            print("‚ùå Í≤∞Ï†ú Í≤ÄÏ¶ù ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: \(error)")
            await MainActor.run {
                // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò Ïãú Í≤∞Ï†ú Ïã§Ìå® Ï≤òÎ¶¨
                if let currentResult = paymentResult {
                    paymentResult = PaymentResult(
                        isSuccess: false,
                        impUID: currentResult.impUID,
                        merchantUID: currentResult.merchantUID,
                        errorMessage: "Í≤∞Ï†ú Í≤ÄÏ¶ù Ï§ë ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
                    )
                }
            }
        }
    }
}

// MARK: - WKWebView SwiftUI Wrapper
struct WebViewRepresentable: UIViewRepresentable {
    let webView: WKWebView

    func makeUIView(context: Context) -> WKWebView {
        return webView
    }

    func updateUIView(_ uiView: WKWebView, context: Context) {
        // ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÌïÑÏöîÌïú Í≤ΩÏö∞ Íµ¨ÌòÑ
    }
}

// MARK: - Ï£ºÎ¨∏ ÏöîÏïΩ Î∑∞
struct OrderSummaryView: View {
    let paymentInfo: PaymentInfo

    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Ï£ºÎ¨∏ Ï†ïÎ≥¥")
                .font(.headline)

            VStack(alignment: .leading, spacing: 8) {
                HStack {
                    Text("Ï£ºÎ¨∏ Î≤àÌò∏:")
                    Spacer()
                    Text(paymentInfo.orderCode)
                        .fontWeight(.medium)
                }

                HStack {
                    Text("Îß§Ïû•:")
                    Spacer()
                    Text(paymentInfo.storeName)
                        .fontWeight(.medium)
                }
            }

            Divider()

            Text("Ï£ºÎ¨∏ Î©îÎâ¥")
                .font(.headline)

            ForEach(paymentInfo.menuItems.indices, id: \.self) { index in
                let item = paymentInfo.menuItems[index]
                HStack {
                    Text(item.menu.name)
                    Spacer()
                    Text("\(item.quantity)Í∞ú")
                    Text("\(item.totalPrice)Ïõê")
                        .fontWeight(.medium)
                }
            }

            Divider()

            HStack {
                Text("Ï¥ù Í≤∞Ï†ú Í∏àÏï°")
                    .font(.headline)
                Spacer()
                Text("\(paymentInfo.totalPrice)Ïõê")
                    .font(.title2)
                    .fontWeight(.bold)
                    .foregroundColor(.blue)
            }
        }
        .padding()
        .background(Color.gray.opacity(0.1))
        .cornerRadius(12)
        .padding()
    }
}

// MARK: - Í≤∞Ï†ú Í≤∞Í≥º Î∑∞
struct PaymentResultView: View {
    let result: PaymentResult?
    let onDismiss: () -> Void

    var body: some View {
        VStack(spacing: 20) {
            Image(systemName: result?.isSuccess == true ? "checkmark.circle.fill" : "xmark.circle.fill")
                .font(.system(size: 64))
                .foregroundColor(result?.isSuccess == true ? .green : .red)

            Text(result?.isSuccess == true ? "Í≤∞Ï†ú ÏôÑÎ£å" : "Í≤∞Ï†ú Ïã§Ìå®")
                .font(.title)
                .fontWeight(.bold)

            if let result = result {
                if result.isSuccess {
                    Text("Í≤∞Ï†úÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.")
                        .multilineTextAlignment(.center)

                    if let impUID = result.impUID {
                        Text("Í≤∞Ï†ú Î≤àÌò∏: \(impUID)")
                            .font(.caption)
                            .foregroundColor(.gray)
                    }
                } else {
                    Text(result.errorMessage ?? "Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
                        .multilineTextAlignment(.center)
                        .foregroundColor(.red)
                }
            }

            Button("ÌôïÏù∏") {
                onDismiss()
            }
            .frame(maxWidth: .infinity)
            .padding()
            .background(Color.blue)
            .foregroundColor(.white)
            .cornerRadius(12)
            .padding(.horizontal)
        }
        .padding()
    }
}

// MARK: - ÎØ∏Î¶¨Î≥¥Í∏∞
struct PaymentView_Previews: PreviewProvider {
    static var previews: some View {
        let samplePaymentInfo = PaymentInfo(
            orderID: "test-order-id",
            orderCode: "TEST123",
            totalPrice: 15000,
            storeName: "ÌÖåÏä§Ìä∏ Îß§Ïû•",
            menuItems: [],
            createdAt: "2025-06-09T05:33:27.315Z"
        )

        // AppRouterÏùò mock Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§
        // PaymentView(paymentInfo: samplePaymentInfo, router: MockAppRouter())
        Text("PaymentView Preview")
    }
}
